name: Pull Request Checks

# Pipeline meant to run on pull-requests

on: [workflow_dispatch, pull_request]

jobs:
  # stage 1: smoke tests
  # - Only depends on tools already available in the base image.
  lint:
    name: Code formatting
    runs-on: ubuntu-20.04 
    steps:
    - uses: actions/checkout@v2
      
    - name: Check clang-format
      run: |
        pwd
        ls -la
        find . -regex '.*\.\(cpp\|h\)'  -exec clang-format-12 -style=file -i -n -Werror {} +

  basic-build:
    name: Basic Build
    runs-on: ubuntu-20.04 
    env:
      CC: clang-12
      CXX: clang++-12

    steps:
    - uses: actions/checkout@v2

    - name: Configure CMake
      run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=Debug -DABU_HEADER_CHECKS=ON

    - name: Build
      run: cmake --build ${{github.workspace}}/build

    - name: Test
      working-directory: ${{github.workspace}}/build
      run: ctest
    
  # stage 2: Static analysis
  static-analysis:
    needs: [lint, basic-build]
    name: Static Analysis
    runs-on: ubuntu-20.04
    env:
      CC: clang-12
      CXX: clang++-12

    steps:
      - uses: actions/checkout@v2

      - name: install dependencies
        run: |
          sudo apt update
          sudo apt install -y clang-tidy-12
          sudo update-alternatives --install /usr/bin/clang-tidy clang-tidy /usr/bin/clang-tidy-12 100

      - name: Compute compile commands
        run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DABU_HEADER_CHECKS=ON

      - name: Normalize directory structure
        run: |
          mkdir build/abu_header_checks 1>/dev/null 2>/dev/null || true
          mkdir src 1>/dev/null 2>/dev/null  || true
          mkdir tests 1>/dev/null 2>/dev/null  || true
          mkdir benchmarks 1>/dev/null 2>/dev/null  || true

      - name: Check with clang-tidy
        run: |  
          find build/abu_header_checks src tests benchmarks -regex '.*\.\(cpp\)' -exec clang-tidy -format-style=file -p build {} +

  # stage 3: Validation
  build-and-test-ubuntu:
    needs: static-analysis
    runs-on: ubuntu-20.04 

    strategy:
      matrix:
        compiler: [{cc: gcc-11, cxx: g++-11}, {cc: clang-12, cxx: clang++-12}]
        build_type: [Debug, Release]
    
    env:
      CC: ${{matrix.compiler.cc}}
      CXX: ${{matrix.compiler.cxx}}

    steps:
      - uses: actions/checkout@v2

      - name: Set up GCC
        if: ${{ matrix.compiler.cc == 'gcc-11' }}
        uses: egor-tensin/setup-gcc@v1
        with:
          version: 11
          platform: x64

      - name: Configure CMake
        run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=Debug -DABU_HEADER_CHECKS=ON

      - name: Build
        run: cmake --build ${{github.workspace}}/build

      - name: Test
        working-directory: ${{github.workspace}}/build
        run: ctest